---
# Shared user_data script (using YAML anchor to avoid duplication)
x-user-data: &user-data-script |
  #!/bin/bash
  
  set -e
  
  # 1. Install kubectl
  if ! command -v kubectl &> /dev/null; then
      KUBECTL_VERSION="v1.32.0"
      curl -LO "https://dl.k8s.io/release/${KUBECTL_VERSION}/bin/linux/amd64/kubectl"
      chmod +x kubectl
      sudo mv kubectl /usr/local/bin/
  fi
  
  # 2. Install Helm
  curl -fsSL https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 | bash
  
  # 3. Install AWS CLI v2
  curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o awscliv2.zip
  unzip awscliv2.zip
  sudo ./aws/install --update
  rm -rf aws awscliv2.zip
  
  # 4. Install Terraform
  wget https://releases.hashicorp.com/terraform/1.13.3/terraform_1.13.3_linux_amd64.zip
  unzip terraform_1.13.3_linux_amd64.zip
  sudo mv terraform /usr/local/bin/
  rm terraform_1.13.3_linux_amd64.zip
  
  # Fix environment issues in user data
  export HOME="/home/ubuntu"
  export USER="ubuntu"
  export PATH="/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin"
  
  # Create krew directory
  mkdir -p "$HOME/.krew/bin"
  
  # Download and install krew
  (
      set -e
      cd "$(mktemp -d)"
      
      OS="$(uname | tr '[:upper:]' '[:lower:]')"
      ARCH="$(uname -m | sed -e 's/x86_64/amd64/' -e 's/\(arm\)\(64\)\?.*/\1\2/' -e 's/aarch64$/arm64/')"
      KREW="krew-${OS}_${ARCH}"
      
      curl -fsSLO "https://github.com/kubernetes-sigs/krew/releases/latest/download/${KREW}.tar.gz"
      tar zxvf "${KREW}.tar.gz"
      ./"${KREW}" install krew
  )
  
  # Add to shell profiles
  echo 'export PATH="${KREW_ROOT:-$HOME/.krew}/bin:$PATH"' >> "$HOME/.bashrc"
  echo 'export PATH="${KREW_ROOT:-$HOME/.krew}/bin:$PATH"' >> "$HOME/.profile"
  echo 'export KREW_ROOT="$HOME/.krew"' >> "$HOME/.bashrc"
  
  # Set permissions
  chown -R ubuntu:ubuntu "$HOME/.krew"
  chmod 755 "$HOME/.krew/bin"
  
  # Create global symlink
  if [ -f "$HOME/.krew/bin/kubectl-krew" ]; then
      sudo ln -sf "$HOME/.krew/bin/kubectl-krew" /usr/local/bin/kubectl-krew
  fi
  
  # Test installation
  export PATH="${KREW_ROOT:-$HOME/.krew}/bin:$PATH"
  export KREW_ROOT="$HOME/.krew"
  
  # Fix kubectl config permissions
  mkdir -p /home/ubuntu/.kube
  chown -R ubuntu:ubuntu /home/ubuntu/.kube
  chmod 700 /home/ubuntu/.kube
  
  # Install the oidc-login plugin
  if command -v kubectl-krew >/dev/null 2>&1; then
      kubectl krew update
      kubectl krew install oidc-login
  fi
  
  # Configure kubectl cluster
  kubectl config set-cluster zoodemy-k8s-dev.zdemyk8sd.int.aws.zooplus.io --server=https://zoodemy-k8s-dev.zdemyk8sd.int.aws.zooplus.io
  
  # Create keycloak user configuration
  kubectl config set-credentials keycloak \
      --exec-command=/home/ubuntu/.krew/bin/kubectl-oidc_login \
      --exec-api-version=client.authentication.k8s.io/v1beta1 \
      --exec-arg=get-token \
      --exec-arg=--oidc-issuer-url=https://login.prod.zooplus.net/auth/realms/zoo-office \
      --exec-arg=--oidc-client-id=kubernetes \
      --exec-arg=--oidc-redirect-url=urn:ietf:wg:oauth:2.0:oob \
      --exec-arg=--grant-type=authcode-keyboard
  
  # Set the context
  kubectl config set-context zoodemy-k8s-dev.zdemyk8sd.int.aws.zooplus.io --cluster=zoodemy-k8s-dev.zdemyk8sd.int.aws.zooplus.io --user=keycloak
  
  # Set the current context
  kubectl config use-context zoodemy-k8s-dev.zdemyk8sd.int.aws.zooplus.io
  
  # Fix permissions after config changes
  chown ubuntu:ubuntu /home/ubuntu/.kube/config
  chmod 600 /home/ubuntu/.kube/config
  
  # Webhook
  cat <<EOF >> /home/ubuntu/.bashrc
  export STRIGO_USER_EMAIL="{{ .STRIGO_USER_EMAIL }}"
  export ZOOPLUS_USER_NAME="\$(echo \${STRIGO_USER_EMAIL%@*} | tr '.' '-'| tr '_' '-')"
  EOF
  
  source /etc/strigo_env
  
  payload=$(cat <<EOF
  { "status": "initialized" }
  EOF
  )
  
  curl -X POST "$STRIGO_INSTANCE_STATUS_UPDATE_ENDPOINT" \
    -H "Content-Type: application/json" \
    -H "Authorization: Bearer $STRIGO_JWT_TOKEN" \
    -d "$payload"

classes:
  # Class 1 - Test: Github integration
  - class_id: "692493e7068eb74399df7a41"
    lab_resources:
      - display_name: "Class 1 Lab Configuration"
        platform_type: "lab"
        image_platform: "linux"
        view_interface: "desktop"
        cloud_provider: "aws"
        aws_vm_definition:
          machine_size: "t3.medium"
          ami_region_mapping:
            eu-central-1:
              image_id: "ami-003c60acc3656b8db"
          custom_username: "ubuntu"
        user_data: *user-data-script
    exercises:
      - file: "../exercises-class-1/class-1-lesson-1.md"
        title: "Class 1: Lesson 1"
        syntax: "md"


  # Class 2 - Test: Github integration-2
  - class_id: "6926141e84da085468ffebe2"
    lab_resources:
      - display_name: "Class 2 Lab Configuration"
        platform_type: "lab"
        image_platform: "linux"
        view_interface: "desktop"
        cloud_provider: "aws"
        aws_vm_definition:
          machine_size: "t3.medium"
          ami_region_mapping:
            eu-central-1:
              image_id: "ami-003c60acc3656b8db"
          custom_username: "ubuntu"
        user_data: *user-data-script
    exercises:
      - file: "../exercises-class-2/class-2-lesson-1.md"
        title: "Class 2: Lesson 1"
        syntax: "md"
